# 人脸姿态检测增强说明

## 问题
之前仍可能抓取到侧脸或背面的图片

## 解决方案

### 1. 增强的正脸检测 (`isFrontalFace`)

#### 新增检测维度：

| 检测项 | 说明 | 阈值 | 效果 |
|--------|------|------|------|
| **Roll 角** | 头部左右倾斜 | 15° (原20°) | 更严格 |
| **Yaw 角** | 头部左右旋转 | 0.2 (原0.25) | 更严格 |
| **Pitch 角** | 头部俯仰角度 | 0.3 (新增) | 过滤低头/抬头 |
| **眼睛间距** | 相对于脸宽 | >0.15 (新增) | 过滤侧脸 |
| **嘴巴对称性** | 相对于眼睛中心 | <0.15 (新增) | 确保正面 |
| **鼻子位置** | 在眼睛和嘴之间 | 是 (新增) | 验证关键点 |

#### 检测逻辑：
```cpp
正脸 = roll角<15° AND yaw角<0.2 AND pitch角<0.3 
       AND 眼睛间距>0.15 AND 嘴巴对称<0.15 
       AND 鼻子位置合理
```

**必须同时满足所有条件！**

### 2. 严格的侧脸判断 (`isSideFace`)

- Yaw 角范围：**0.2 ~ 0.6**（原 0.25 ~ 0.6）
- 超过 0.6 视为背面或极端侧脸，直接丢弃

### 3. 可配置的阈值 (main.h)

```cpp
// 人脸姿态检测阈值
#define FACE_YAW_THRESH         0.2f    // 水平旋转
#define FACE_ROLL_THRESH        15.0f   // 倾斜角度
#define FACE_PITCH_THRESH       0.3f    // 俯仰角度
#define FACE_EYE_DISTANCE_MIN   0.15f   // 眼睛间距
#define FACE_SYMMETRY_THRESH    0.15f   // 对称性
```

## 调整建议

### 如果漏检太多（正脸也被过滤）

放宽阈值：
```cpp
#define FACE_YAW_THRESH         0.25f   // 0.2 → 0.25
#define FACE_ROLL_THRESH        20.0f   // 15 → 20
#define FACE_PITCH_THRESH       0.4f    // 0.3 → 0.4
#define FACE_EYE_DISTANCE_MIN   0.12f   // 0.15 → 0.12
#define FACE_SYMMETRY_THRESH    0.2f    // 0.15 → 0.2
```

### 如果仍有侧脸（需要更严格）

收紧阈值：
```cpp
#define FACE_YAW_THRESH         0.15f   // 0.2 → 0.15
#define FACE_ROLL_THRESH        10.0f   // 15 → 10
#define FACE_PITCH_THRESH       0.25f   // 0.3 → 0.25
#define FACE_EYE_DISTANCE_MIN   0.18f   // 0.15 → 0.18
#define FACE_SYMMETRY_THRESH    0.12f   // 0.15 → 0.12
```

## 测试方法

### 1. 编译测试
```bash
cd build
make main -j4
```

### 2. 观察日志
运行后注意日志中是否有：
- 正脸被正确识别
- 侧脸被过滤（不会生成 face_roi）
- 背面被丢弃（continue）

### 3. 检查上传图片
确认上传的图片中：
- ✅ 都是正脸
- ❌ 没有侧脸
- ❌ 没有背面

## 姿态角度说明

### Yaw（偏航角）- 左右转头
```
   0.0  = 正面
  -0.2  = 稍向右转
  +0.2  = 稍向左转
  ±0.5  = 明显侧脸
  ±1.0  = 90度侧脸
```

### Roll（滚转角）- 左右歪头
```
   0°   = 头部正直
  ±15°  = 轻微歪头
  ±30°  = 明显歪头
  ±45°  = 严重歪头
```

### Pitch（俯仰角）- 抬头低头
```
   0.0  = 平视
  -0.3  = 轻微抬头
  +0.3  = 轻微低头
  ±0.5  = 明显抬/低头
```

## 检测示例

### ✅ 会通过的情况
- 正面面对摄像头
- 轻微歪头（<15°）
- 轻微转头（yaw<0.2）
- 眼睛清晰可见且间距正常
- 嘴巴位置对称

### ❌ 会被过滤的情况
- 侧脸（yaw≥0.2）
- 背面（yaw≥0.6）
- 严重歪头（roll≥15°）
- 低头/抬头（pitch≥0.3）
- 眼睛间距太小（侧脸特征）
- 嘴巴位置不对称

## 性能影响

新增的检测逻辑计算量很小（~0.1ms），对性能几乎无影响。

## 验证清单

- [ ] 编译成功
- [ ] 正脸能正常识别
- [ ] 侧脸被过滤
- [ ] 背面被过滤  
- [ ] 低头/抬头被过滤
- [ ] 歪头被过滤
- [ ] 上传的都是高质量正脸
